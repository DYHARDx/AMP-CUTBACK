<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .loader-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="loader-container">
        <div class="spinner"></div>
        <p style="color: var(--text-muted)">Please wait while we redirect you...</p>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import {
            doc,
            getDoc,
            updateDoc,
            increment,
            addDoc,
            collection,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('l');

        async function handleRedirect() {
            if (!linkId) {
                window.location.replace('index.html');
                return;
            }

            const storageKey = `last_click_date_${linkId}`;
            const urlKey = `target_url_${linkId}`;
            const lastClickDate = localStorage.getItem(storageKey);
            const cachedUrl = localStorage.getItem(urlKey);

            // Calendar Day Logic (Resets at midnight)
            const todayStr = new Date().toLocaleDateString('en-CA');
            const shouldIncrement = lastClickDate !== todayStr;

            // 1. Instant Redirect Plan (Only if we don't need to count)
            if (!shouldIncrement && cachedUrl) {
                window.location.replace(cachedUrl);
                return;
            }

            try {
                // Must fetch to get URL or update counts
                const linkDocRef = doc(db, 'links', linkId);
                const linkSnap = await getDoc(linkDocRef);

                if (linkSnap.exists()) {
                    const linkData = linkSnap.data();
                    const targetUrl = linkData.originalUrl;
                    localStorage.setItem(urlKey, targetUrl);

                    if (shouldIncrement) {
                        // Perform count update accurately
                        const clicks = (linkData.clicks || 0) + 1;
                        const convs = linkData.conversions || 0;
                        let isConversion = false;

                        const min = linkData.minCr || 0;
                        const max = linkData.maxCr || 100;
                        const targetConv = linkData.batchConv || 1;
                        const targetClicks = linkData.batchClicks || 10;
                        const currentCr = clicks > 0 ? (convs / clicks) * 100 : 0;

                        if (currentCr < min) isConversion = true;
                        else if (currentCr > max) isConversion = false;
                        else isConversion = convs < Math.floor(clicks * (targetConv / targetClicks));

                        const updates = { clicks: increment(1) };
                        if (isConversion) updates.conversions = increment(1);

                        // Await ensures the count is saved before redirection
                        await updateDoc(linkDocRef, updates);

                        // Update Daily Stats
                        try {
                            const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                            const dailyRef = doc(db, 'links', linkId, 'dailyStats', dateStr);
                            const dailyUpdates = { clicks: increment(1) };
                            if (isConversion) dailyUpdates.conversions = increment(1);
                            await setDoc(dailyRef, dailyUpdates, { merge: true });
                        } catch (err) {
                            console.error("Daily stats error:", err);
                        }

                        localStorage.setItem(storageKey, todayStr);
                    }

                    window.location.replace(targetUrl);
                } else {
                    window.location.replace('index.html');
                }
            } catch (error) {
                console.error("Redirect error:", error);
                // Fallback to cached URL if count fails, else index
                if (cachedUrl) window.location.replace(cachedUrl);
                else window.location.replace('index.html');
            }
        }

        handleRedirect();
    </script>
</body>

</html>