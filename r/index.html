<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Bridge...</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .loader-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: #030712;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.05);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="loader-container">
        <div class="spinner"></div>
        <p style="color: #94a3b8; font-family: 'Outfit', sans-serif;">Initializing Secure Protocol...</p>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import {
            doc,
            getDoc,
            updateDoc,
            setDoc,
            increment,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Support for both /r?l=ID and /r/ID (with rewrites)
        const urlParams = new URLSearchParams(window.location.search);
        let linkId = urlParams.get('l');

        if (!linkId) {
            // Check if path contains the ID: /r/ID
            const pathParts = window.location.pathname.split('/');
            // The ID would be the last part if it follows /r/ID
            // If the URL ends with /r/, this might not work without rewrites
            // But we'll try to extract it
            const lastPart = pathParts[pathParts.length - 1];
            if (lastPart && lastPart !== 'index.html' && lastPart !== 'r') {
                linkId = lastPart;
            }
        }

        async function handleRedirect() {
            if (!linkId || linkId === '') {
                window.location.replace('../index.html');
                return;
            }

            const storageKey = `last_click_${linkId}`;
            const urlKey = `target_url_${linkId}`;
            const lastClick = localStorage.getItem(storageKey);
            const cachedUrl = localStorage.getItem(urlKey);
            const now = Date.now();
            // 1. Reduce cache/debounce time to 10 seconds for testing/liveliness
            const debounceTime = 10 * 1000;
            const shouldIncrement = !lastClick || (now - parseInt(lastClick)) > debounceTime;

            // REMOVED: Early return with cachedUrl. We always want to fetch latest data/URL.
            // If network fails, we'll fall back to cache in the catch block.

            try {
                const linkDocRef = doc(db, 'links', linkId);
                const linkSnap = await getDoc(linkDocRef);

                if (linkSnap.exists()) {
                    const linkData = linkSnap.data();
                    const targetUrl = linkData.originalUrl;

                    // Update cache for fallback
                    localStorage.setItem(urlKey, targetUrl);

                    if (shouldIncrement) {
                        const clicks = (linkData.clicks || 0) + 1;
                        const convs = linkData.conversions || 0;
                        let isConversion = false;

                        const min = linkData.minCr || 0;
                        const max = linkData.maxCr || 100;
                        const targetConv = linkData.batchConv || 1;
                        const targetClicks = linkData.batchClicks || 10;
                        const currentCr = (convs / clicks) * 100;

                        if (currentCr < min) isConversion = true;
                        else if (currentCr > max) isConversion = false;
                        else isConversion = convs < Math.floor(clicks * (targetConv / targetClicks));

                        const updates = { clicks: increment(1) };
                        if (isConversion) updates.conversions = increment(1);

                        await updateDoc(linkDocRef, updates);

                        // Update Daily Stats (Per Link)
                        try {
                            // Use local date (YYYY-MM-DD) instead of UTC to match user's day
                            const dateStr = new Date().toLocaleDateString('en-CA');
                            const dailyRef = doc(db, 'links', linkId, 'dailyStats', dateStr);
                            const dailyUpdates = { clicks: increment(1) };
                            if (isConversion) dailyUpdates.conversions = increment(1);
                            await setDoc(dailyRef, dailyUpdates, { merge: true });

                            // Update Global Daily Stats (For Dashboard)
                            const globalDailyRef = doc(db, 'analytics', 'daily_stats', 'days', dateStr);
                            await setDoc(globalDailyRef, dailyUpdates, { merge: true });

                        } catch (err) {
                            console.error("Daily stats error:", err);
                        }

                        localStorage.setItem(storageKey, now.toString());
                    }

                    window.location.replace(targetUrl);
                } else {
                    window.location.replace('../index.html');
                }
            } catch (error) {
                console.error("Redirect logic error:", error);
                if (cachedUrl) window.location.replace(cachedUrl);
                else window.location.replace('../index.html');
            }
        }

        // Safety Timeout (5 seconds) - If Firebase fails or hangs
        const safetyTimeout = setTimeout(() => {
            console.warn("Redirect time limit exceeded. Forcing fallback.");
            const urlKey = `target_url_${linkId}`;
            const cachedUrl = localStorage.getItem(urlKey);
            if (cachedUrl) window.location.replace(cachedUrl);
            else window.location.replace('../index.html');
        }, 5000);

        handleRedirect().then(() => clearTimeout(safetyTimeout));
    </script>
</body>

</html>