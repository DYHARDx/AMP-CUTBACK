<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Intelligence | AMP Mediaz</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header class="user-header glass">
        <div class="header-branding">
            <img id="user-logo" src="logo.png" alt="" style="height: 30px;"
                onerror="this.src='https://via.placeholder.com/40x40?text=A'">
            <div class="header-text">
                <h2 id="user-site-name" style="font-size: 1rem; font-weight: 700;">AMP Mediaz</h2>
                <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1;">
                    Campaign Data Hub
                </div>
            </div>
        </div>

        <div class="header-actions">
            <a href="dashboard.html" class="btn btn-outline btn-sm">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
            <button onclick="toggleTheme()" class="btn btn-outline btn-round">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="user-container">
        <div class="dashboard-title-area">
            <div>
                <p style="color: var(--text-muted); margin-bottom: 0.5rem;" id="link-affiliate-name">Loading
                    Affiliate...</p>
                <h1 class="page-title" id="campaign-title">Analysing Bridge...</h1>
            </div>
            <div class="title-badge-wrapper">
                <span class="badge badge-active pulse">REAL-TIME DATA</span>
            </div>
        </div>

        <div class="stats-grid grid-4-col animate-fade-in">
            <div class="stat-card"
                style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none;">
                <div class="stat-label" style="color: rgba(255,255,255,0.8);">Efficiency Index</div>
                <div id="campaign-cr" class="stat-value" style="color: white;">0%</div>
                <div class="stat-label" style="color: rgba(255,255,255,0.6);">Conversion Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Click Ratio</div>
                <div id="campaign-ratio" class="stat-value text-gradient">1:1</div>
                <div class="stat-label">Loss Prevention</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Clicks</div>
                <div id="campaign-clicks" class="stat-value">0</div>
                <div class="stat-label">Global Traffic</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Conversions</div>
                <div id="campaign-conversions" class="stat-value">0</div>
                <div class="stat-label">Verified Actions</div>
            </div>
        </div>

        <div class="glass" style="padding: 2.5rem; border-radius: 24px; margin-bottom: 2.5rem; position: relative;">
            <div style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 0.5rem; font-weight: 700;">Your Dedicated Tracking Bridge</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Copy this link and share it across your traffic
                    networks. Every click is analyzed in milliseconds.</p>
            </div>

            <div
                style="display: flex; gap: 15px; background: var(--bg); padding: 10px; border-radius: 16px; border: 1px solid var(--border);">
                <input type="text" id="campaign-url" readonly
                    style="flex: 1; border: none; background: transparent; font-family: monospace; font-size: 0.9rem; padding: 10px;">
                <button class="btn btn-primary" onclick="copyUrl()" style="border-radius: 12px; padding: 0 25px;">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>

        <div class="table-container animate-fade-in"
            style="margin-bottom: 2.5rem; border: 1px solid rgba(var(--p-rgb), 0.15);">
            <div
                style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(var(--p-rgb), 0.02);">
                <div>
                    <h3 style="font-weight: 700; margin-bottom: 4px;"><i class="fas fa-calendar-day"
                            style="color: var(--primary); margin-right: 8px;"></i>Daily Performance Breakdown</h3>
                    <p style="font-size: 0.75rem; color: var(--text-muted);">Timestamped traffic distribution across the
                        node network.</p>
                </div>
                <div style="text-align: right; display: flex; gap: 10px; align-items: center;">

                    <span class="badge"
                        style="background: rgba(var(--p-rgb), 0.1); color: var(--primary); font-size: 0.7rem;">SYNCING
                        LIVE</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date (Partition)</th>
                        <th>Campaign</th>
                        <th>Affiliate</th>
                        <th>Unique Hits</th>
                        <th>Conversions</th>
                        <th style="text-align: right;">Efficiency (CR)</th>
                    </tr>
                </thead>
                <tbody id="daily-stats-table">
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 3rem;">
                            <div class="spinner"
                                style="width:1.5rem; height:1.5rem; margin: 0 auto 1rem; border-width: 2px;"></div>
                            Accessing distributed logs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="table-container animate-fade-in">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3 style="font-weight: 700;">System Event Log</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Network Protocol</td>
                        <td>HTTPS / WSS (Secure)</td>
                    </tr>
                    <tr>
                        <td>Tracking ID</td>
                        <td id="campaign-id" style="font-family: monospace; color: var(--primary);">Loading...</td>
                    </tr>
                    <tr>
                        <td>Active Status</td>
                        <td><span class="badge badge-active">Operational</span></td>
                    </tr>
                    <tr>
                        <td>Traffic Origin</td>
                        <td>Global Nodes Active</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="js/theme.js"></script>
    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import {
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            query,
            orderBy,
            limit,
            documentId
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get('id');



        if (!campaignId) {
            window.location.href = 'index.html';
            throw "Redirecting: Missing Campaign ID";
        }

        // State Management
        let masterLinkData = null;
        let dailyStatsRows = null; // null means not yet fetched, [] means empty

        // Consolidated UI Update
        const updateUI = () => {
            const dailyTableBody = document.getElementById('daily-stats-table');
            if (!dailyTableBody) return;

            // 1. Update Master Stats (Top of page)
            if (masterLinkData) {
                const data = masterLinkData;
                const cr = data.clicks > 0 ? ((data.conversions / data.clicks) * 100).toFixed(1) : '0.0';
                const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const shortUrl = `${window.location.origin}${currentPath}/r/?l=${campaignId}`;

                document.getElementById('campaign-title').innerText = data.name || 'Untitled Campaign';
                document.getElementById('campaign-clicks').innerText = (data.clicks || 0).toLocaleString();
                document.getElementById('campaign-conversions').innerText = (data.conversions || 0).toLocaleString();
                document.getElementById('campaign-cr').innerText = cr + '%';

                const ratioValue = data.clicks > 0 ? (data.clicks / (data.conversions || 1)).toFixed(0) : 1;
                document.getElementById('campaign-ratio').innerText = `1:${ratioValue}`;
                document.getElementById('campaign-url').value = shortUrl;
                document.getElementById('campaign-id').innerText = campaignId;
                document.getElementById('link-affiliate-name').innerText = "Affiliate: " + (data.affiliateEmail || 'N/A');
            }

            // 2. Update Daily Table
            if (dailyStatsRows === null || !masterLinkData) {
                // Still waiting for initial data sync from both listeners
                return;
            }

            if (dailyStatsRows.length === 0) {
                dailyTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 4rem;">
                            <i class="fas fa-layer-group" style="font-size: 2rem; opacity: 0.1; display: block; margin-bottom: 1rem;"></i>
                            No daily records detected in the node network.
                        </td>
                    </tr>`;
                return;
            }

            // Build table rows
            const rowsHtml = dailyStatsRows.map(stat => {
                const data = stat.data;
                const dateId = stat.id;
                let displayDate = dateId;

                try {
                    const parts = dateId.split('-');
                    if (parts.length === 3) {
                        const [y, m, d] = parts.map(p => parseInt(p));
                        const dateObj = new Date(y, m - 1, d);
                        displayDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    }
                } catch (e) { }

                const clicks = data.clicks || 0;
                const conversions = data.conversions || 0;
                const cr = clicks > 0 ? ((conversions / clicks) * 100).toFixed(2) : '0.00';

                return `
                    <tr>
                        <td style="font-weight: 600; color: var(--text);">${displayDate}</td>
                        <td style="font-weight: 500;">${masterLinkData.name || 'Unknown'}</td>
                        <td style="color: var(--text-muted); font-size: 0.85rem;">${masterLinkData.affiliateEmail || 'N/A'}</td>
                        <td style="font-family: monospace; font-weight: 600;">${clicks.toLocaleString()}</td>
                        <td style="font-family: monospace; color: var(--secondary); font-weight: 600;">${conversions.toLocaleString()}</td>
                        <td style="text-align: right;">
                            <span style="background: rgba(var(--s-rgb), 0.1); color: var(--secondary); padding: 6px 12px; border-radius: 8px; font-weight: 800; font-family: monospace;">
                                ${cr}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            dailyTableBody.innerHTML = rowsHtml;
        };

        // Security & Data Initialization
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, 'users', user.email));
                if (userDoc.exists()) {
                    const role = userDoc.data().role;
                    const backBtn = document.querySelector('.header-actions a');
                    if (role === 'admin') {
                        backBtn.href = 'admin.html';
                        backBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Control Hub';
                    }
                }

                // Start Live Listeners
                startListeners();

                // One-time branding load
                const settingsDoc = await getDoc(doc(db, 'settings', 'branding'));
                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    if (data.websiteName) document.getElementById('user-site-name').innerText = data.websiteName;
                    if (data.logoUrl) document.getElementById('user-logo').src = data.logoUrl;
                }
            } catch (err) {
                console.error("Auth/Init Error:", err);
            }
        });

        function startListeners() {
            // master doc listener
            onSnapshot(doc(db, 'links', campaignId), (docSnap) => {
                if (docSnap.exists()) {
                    masterLinkData = docSnap.data();
                    updateUI();
                } else {
                    document.body.innerHTML = `<div style="padding:4rem; text-align:center; font-family:sans-serif;">
                        <h2>404 - Campaign Records Not Found</h2>
                        <p>The tracking ID might be invalid or purged.</p>
                        <a href="index.html" style="color:blue;">Return to Command Center</a>
                    </div>`;
                }
            }, (error) => {
                console.error("Link sync error:", error);
            });

            // daily stats listener - Switch to client-side sorting to bypass index requirement
            const q = query(collection(db, 'links', campaignId, 'dailyStats'));
            onSnapshot(q, (snapshot) => {
                let rows = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
                // Sort by ID (Date YYYY-MM-DD) descending
                rows.sort((a, b) => b.id.localeCompare(a.id));
                // Limit to latest 30 records
                dailyStatsRows = rows.slice(0, 30);
                updateUI();
            }, (error) => {
                console.error("Stats sync error:", error);
                const table = document.getElementById('daily-stats-table');
                if (table) table.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--danger); padding:2rem;">Data Access Denied: ${error.message}</td></tr>`;
            });
        }

        window.copyUrl = () => {
            const copyText = document.getElementById("campaign-url");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("Tracking Link Copied!");
        };


    </script>
</body>

</html>